#!/bin/bash

export PATH=/sbin:/usr/sbin:/bin:/usr/bin
<%

def get_token_for_interface(interface) do
  facts = [ "::custom_ipv6_token_#{interface}", "::default_ipv6_token_#{interface}"]
  token = nil
  facts.each do |fact|
    if !scope.lookupvar(fact).to_s.empty?
      token = scope.lookupvar(fact)
      break
    end
  end

  token
end

interfaces = scope.lookupvar('::interfaces')

tokens = Hash.new
interfaces.split(',').each do |interface|
  token = get_token_for_interface(interface)
  if token
    tokens[interface] = token
  end
end

tokens.keys.each do |interface| -%>
ip token set <%= tokens[interface] %> dev <%= interface %>
<%
end

if tokens.length == 0 do
  -%>
  # Error: puppet-module-ipv6token failed to calculate any ipv6 tokens.
  # Interfaces found: <%= interfaces %>
  <%
end
%>